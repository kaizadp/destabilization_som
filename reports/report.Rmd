---
title: "SOM destabilization"
output: github_document
---

```{r setup_resp, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      collapse = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      comment = "#>",
                      fig.path = ("markdown-figs/report/"))

library(drake)
library(tidyverse)
library(PNWColors)
source("code/0-packages.R")
```


<details>
  <summary>experimental info, click here</summary>
two treatments:

1. desorption: 13C oxalic acid adsorbed to goethite, 5 g goethite+OA added to soil
2. priming: 13C oxalic acid added to soil as solution, 5 g goethite (without substrate) added to soil
3. control: 5 g goethite added to soil, but no OA, only water

Jars were sealed for 48 hours, after which headspace samples were collected and analyzed for CO2 concentration and 13C/12C composition of CO2. 

---

How much substrate was added?

```{r, echo = T}
substrate = "OXALIC ACID"
A_labelled = 0.99
A_unlabelled = 0.0121 

mole_substrate = (12*2) + (1*2) + (16*4) # molar weight of substrate
mole_carbon = 12* 2 # molar weight of carbon in substrate
carbon_atoms = 2
c_fraction = mole_carbon/mole_substrate
```


279.384 mg unlabelled oxalic acid (enrichment = 0.0121) was mixed with 58.700 mg labelled oxalic acid (enrichment = 0.99) in 600 mL deionized water.

```{r, echo = T}
M_labelled = 58.700 # mg
M_unlabelled = 279.384 # mg

# A_mixture * (M_labelled + M_unlabelled) = (A_unlabelled * M_unlabelled) + (A_labelled + M_labelled)
A_mixture = ((A_unlabelled * M_unlabelled) + (A_labelled + M_labelled)) / (M_labelled + M_unlabelled)
print(A_mixture)
```


|   |  value |
|---|---|
| total enrichment | `r round(A_mixture, 4)` |
| total volume (mL) | 600 |
| total oxalic acid (mg) | `r M_labelled + M_unlabelled` |
| total C (mg) | `r (M_labelled + M_unlabelled) * c_fraction` |


**desorption**

20 mL of this solution was added to 5 g goethite.

**priming** 

16 mL of this solution was added to the soil + 5 g goethite. 

|   |  value per 16 mL |
|---|---|
| total enrichment | `r round(A_mixture, 4)` |
| total volume (mL) | 16  |
| total oxalic acid (mg) | `r (M_labelled + M_unlabelled) * 16/600` |
| total C (mg) | `r ((M_labelled + M_unlabelled) * c_fraction) * 16/600` |
| 13C (mg) | `r (M_labelled*c_fraction) * 16/600`

</details>

---

```{r PROCESS}

## COMBINE AND PROCESS THE FILES FIRST
# combine files -----------------------------------------------------------

combine_data = function(soil, weoc, respiration){
  soil_new = 
    soil %>% 
    rename(C_mg_g = totalC_mg_g) %>% 
    mutate(fraction = "soil") %>% 
    dplyr::select(core, fraction, C_mg_g, d13C_VPDB) %>% 
    mutate(core = as.character(core))
  
  weoc_new = 
    weoc %>% 
    rename(C_mg_g = weoc_mg_g) %>% 
    mutate(fraction = "weoc") %>% 
    dplyr::select(core, fraction, C_mg_g, d13C_VPDB) %>% 
    mutate(core = as.character(core))
  
  respiration_new = 
    respiration %>% 
    rename(C_mg_g = CO2C_mg_g,
           d13C_VPDB = D13C_VPDB_CO2) %>% 
    mutate(fraction = "respiration") %>% 
    dplyr::select(core, fraction, C_mg_g, d13C_VPDB)
  
  bind_rows(soil_new, weoc_new, respiration_new) %>% 
    mutate(d13C_VPDB = round(d13C_VPDB,3)) %>% 
    filter(core != 40) %>% 
    drop_na()
  
}

soil_processed = read.csv("data/processed/soil_processed.csv")
weoc_processed = read.csv("data/processed/weoc_processed.csv")
respiration_processed = read.csv("data/processed/respiration_processed.csv")
# respiration_processed = 
#   combined_resp %>% 
#   dplyr::select(core, D13C_VPDB_CO2, CO2_ppm_corr, umoles_CO2, ug_CO2C_g) %>% 
#   mutate(CO2C_mg_g = ug_CO2C_g/1000)
  
  
combined_data = combine_data(soil_processed, weoc_processed, respiration_processed)





core_key = read.csv(file_in("data/core_key.csv")) %>% mutate(core = as.character(core)) %>% filter(skip != "skip")
GRAVMOIST = 0.0261

core_weights = read.csv("data/core_weights.csv")

core_weights_processed = 
  core_weights %>% 
  dplyr::select(core, soil_g, headspace_cm3) %>% 
  rename(fm_soil_g = soil_g) %>% 
  mutate(od_soil_g = fm_soil_g/(GRAVMOIST+1),
         od_soil_g = round(od_soil_g, 1))


combined_data_key = 
  core_key %>% 
  dplyr::select(-skip) %>% 
  left_join(core_weights_processed %>% dplyr::select(core, od_soil_g) %>% mutate(core = as.character(core)), by = "core") %>% 
  left_join(combined_data, by = "core") 

R13C_VPDB = 0.011237

combined_data_processed = 
  combined_data_key %>% 
  mutate(R13C = ((d13C_VPDB/1000) + 1) * R13C_VPDB,
         F13C = R13C/(1+R13C),
         R13C = round(R13C, 4),
         F13C = round(F13C, 4),
         C13_mg_g = F13C * C_mg_g,
         C_mg = C_mg_g * od_soil_g,
         C13_mg = C13_mg_g * od_soil_g)
  # convert delta into R and F
```

<details>
  <summary>overall, preliminary plots</summary>

### Respiration
```{r, fig.height=4, fig.width=5}
combined_data_processed %>% 
  filter(fraction == "respiration") %>% 
  ggplot(aes(x = treatment, y = d13C_VPDB, color = type))+
    geom_boxplot()+
    geom_point(size=3, position = position_dodge(width = 0.75))+
    scale_color_manual(values = pnw_palette("Sailboat", 3))+
    labs(title = "δ13C-CO2",
         y = "δ13C, ‰")+
    theme_kp()+
    NULL

combined_data_processed %>% 
  filter(fraction == "respiration") %>% 
    ggplot(aes(x = treatment, y = C_mg, color = type))+
    geom_boxplot()+
    geom_point(size=3, position = position_dodge(width = 0.75))+
    scale_color_manual(values = pnw_palette("Sailboat", 3))+
    labs(title = "CO2-C evolved",
         y = "CO2-C, mg", 
         caption = "blank-corrected with ambient")+
    theme_kp()+
    NULL

combined_data_processed %>% 
  filter(fraction == "respiration") %>% 
    ggplot(aes(x = treatment, y = C13_mg, color = type))+
    geom_boxplot()+
    geom_point(size=3, position = position_dodge(width = 0.75))+
    scale_color_manual(values = pnw_palette("Sailboat", 3))+
    scale_y_continuous(sec.axis = sec_axis(~. * 1000/13, name = "μmol 13C"))+
    labs(title = "mg of 13C-CO2 evolved")+
    theme_kp()+
    NULL
```
  
### Soil and WEOC  
```{r, fig.height=6, fig.width=5}
combined_data_processed %>% 
  filter(fraction != "respiration") %>% 
  ggplot(aes(x = treatment, y = d13C_VPDB, color = type))+
    geom_boxplot()+
    geom_point(size=3, position = position_dodge(width = 0.75))+
    scale_color_manual(values = pnw_palette("Sailboat", 3))+
    labs(title = "δ13C",
         y = "δ13C, ‰")+
    facet_grid(fraction ~., scales = "free_y")+
    theme_kp()+
    NULL

combined_data_processed %>% 
  filter(fraction != "respiration") %>% 
  ggplot(aes(x = treatment, y = C_mg, color = type))+
  geom_boxplot()+
  geom_point(size=3, position = position_dodge(width = 0.75))+
  scale_color_manual(values = pnw_palette("Sailboat", 3))+
  facet_grid(fraction ~., scales = "free_y")+
  labs(title = "C content")+
  theme_kp()+
  NULL

combined_data_processed %>% 
  filter(fraction != "respiration") %>% 
    ggplot(aes(x = treatment, y = C13_mg, color = type))+
    geom_boxplot()+
    geom_point(size=3, position = position_dodge(width = 0.75))+
    scale_color_manual(values = pnw_palette("Sailboat", 3))+
    labs(title = "mg of 13C")+
    facet_grid(fraction ~., scales = "free_y")+

    theme_kp()+
    NULL
```
  
</details>


--- 


## DESORPTION SAMPLES 

```{r, include=FALSE}
## stats
library(agricolae)

a = aov(C_mg ~ treatment, data = combined_data_processed %>% dplyr::filter(type == "control" & fraction == "respiration"))
(h = HSD.test(a, "treatment"))

a = aov(d13C_VPDB ~ treatment, data = combined_data_processed %>% dplyr::filter(type == "desorption" & fraction == "respiration"))
(h = HSD.test(a, "treatment"))

a = aov(C_mg ~ treatment, data = combined_data_processed %>% dplyr::filter(type == "desorption" & fraction == "respiration"))
(h = HSD.test(a, "treatment"))

a = aov(C13_mg ~ treatment, data = combined_data_processed %>% dplyr::filter(type == "desorption" & fraction == "respiration"))
(h = HSD.test(a, "treatment"))

a = aov(C_mg ~ treatment, data = combined_data_processed %>% dplyr::filter(type == "desorption" & fraction == "weoc"))
(h = HSD.test(a, "treatment"))

a = aov(C_mg ~ treatment, data = combined_data_processed %>% dplyr::filter(type == "desorption" & fraction == "soil"))
(h = HSD.test(a, "treatment"))
```

```{r}
combined_label = tribble(
  ~type, ~treatment, ~fraction, ~d13C_VPDB, ~C_mg, ~label,
  "desorption", "1-time-zero", "respiration", 100, NA, "a",
  "desorption", "2-wetting", "respiration", 100, NA, "ab",
  "desorption", "3-drying", "respiration", 100, NA, "b",
  "desorption", "4-drying-rewetting", "respiration", 100, NA, "c",
  
  "desorption", "1-time-zero", "respiration", NA, 0.03, "a",
  "desorption", "2-wetting", "respiration", NA, 0.03, "b",
  "desorption", "3-drying", "respiration", NA, 0.03, "c",
  "desorption", "4-drying-rewetting", "respiration", NA, 0.03, "a"
  
#  "desorption", "1-time-zero", "weoc", 
#  "desorption", "2-wetting", "weoc", 
#  "desorption", "3-drying", "weoc", 
#  "desorption", "4-drying-rewetting", "weoc", 

  
  
) %>% 
    mutate(fraction = factor(fraction, levels = c("respiration", "weoc", "soil")))

```


```{r, fig.height=7, fig.width=5}
# graphs ------------------------------------------------------------------
control_summary = 
  combined_data_processed %>% 
  filter(type %in% c("control")) %>% 
  group_by(fraction) %>% 
  dplyr::summarise(d13C_VPDB = mean(d13C_VPDB),
                   C_mg = mean(C_mg),
                   C13_mg = mean(C13_mg)) %>% 
  mutate(fraction = factor(fraction, levels = c("respiration", "weoc", "soil")))
  

combined_data_key %>% 
  mutate(fraction = factor(fraction, levels = c("respiration", "weoc", "soil"))) %>% 
  filter(type %in% c("desorption")) %>% 
  ggplot(aes(x = treatment, y = d13C_VPDB, color = fraction))+
  geom_hline(data = control_summary, aes(yintercept = d13C_VPDB), linetype = "dashed", color = "grey30")+
  geom_point(size = 3, show.legend = FALSE) +
  geom_text(data = combined_label, aes(label = label), color = "black")+
  scale_color_manual(values = pnw_palette("Sailboat", 3))+
  labs(title = "δ13C enrichment in each fraction",
       caption = "dashed line = avg of control samples")+
  facet_grid(fraction~., scales = "free_y")+
  theme_kp()+
  NULL

combined_data_processed %>% 
  mutate(fraction = factor(fraction, levels = c("respiration", "weoc", "soil"))) %>% 
  filter(type %in% c("desorption")) %>% 
  ggplot(aes(x = treatment, y = C_mg, color = fraction))+
  geom_hline(data = control_summary, aes(yintercept = C_mg), linetype = "dashed", color = "grey30")+
  geom_point(size = 3, show.legend = FALSE) +
    geom_text(data = combined_label, aes(label = label), color = "black")+
scale_color_manual(values = pnw_palette("Sailboat", 3))+
  labs(title = "total carbon in each fraction (mg)",
       caption = "dashed line = avg of control samples")+
  facet_grid(fraction~., scales = "free_y")+
  theme_kp()+
  NULL

combined_data_processed %>% 
  mutate(fraction = factor(fraction, levels = c("respiration", "weoc", "soil"))) %>% 
  filter(type %in% c("desorption")) %>% 
  ggplot(aes(x = treatment, y = C13_mg, color = fraction, shape = type))+
  geom_hline(data = control_summary, aes(yintercept = C13_mg), linetype = "dashed", color = "grey30")+
  geom_point(size = 3, show.legend = FALSE) +
  scale_color_manual(values = pnw_palette("Sailboat", 3))+
  labs(title = "13C in each fraction (mg)",
       caption = "dashed line = avg of control samples")+
  facet_grid(fraction~., scales = "free_y")+
  theme_kp()+
  NULL
# -------------------------------------------------------------------------

```

- wetting vs. drying-rewetting: 
  - respiration: similar enrichment. drying-rewetting showed significantly greater CO2 evolution. 
  - WEOC: similar enrichment and similar amount of WEOC
- drying increased the WEOC pool and also the WEOC enrichment -- (a) desorption of labelled C, (b) negative enrichment: labelled C accumulated in the WEOC because it was not consumed/respired. the enrichment and size of WEOC pool decreased when the soil was rewet, indicating that it was consumed. 



### mass balance
```{r, fig.width=8}
## 13C stacked plots
combined_data_processed_summary = 
  combined_data_processed %>% 
  group_by(treatment, type, fraction) %>%
  dplyr::summarise(C13_mg = mean(C13_mg))
  

combined_data_processed_summary %>% 
  filter(fraction != "soil") %>% 
  ggplot(aes(x = treatment, y = C13_mg, fill = fraction))+
  geom_bar(stat = "identity")+
  facet_wrap(~type)+
  theme_kp()+
  theme(axis.text.x = element_text(angle = 45))+
  NULL
```


## PRIMING SAMPLES

```{r, fig.height=7, fig.width=3}
combined_data_processed %>% 
  mutate(fraction = factor(fraction, levels = c("respiration", "weoc", "soil"))) %>% 
  filter(type %in% c("priming")) %>% 
  ggplot(aes(x = treatment, y = C13_mg_g*od_soil_g, color = fraction))+
  #geom_hline(data = control_summary, aes(yintercept = d13C_VPDB), linetype = "dashed", color = "grey30")+
  geom_point(size = 3, show.legend = FALSE) +
  scale_color_manual(values = pnw_palette("Sailboat", 3))+
  labs(title = "C13 content of each experimental unit",
       caption = "dashed line = avg of control samples",
       y = "C13 (mg)")+
  facet_grid(fraction~., scales = "free_y")+
  theme_kp()+
  NULL

```


---

<details>
  <summary>Session Info</summary>

**Kaizad F. Patel**


Date Run: `r Sys.Date()`

```{r}
sessionInfo()
```

</details>


--- 